

<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="description" content="yukihrがfjordさんでのインターンをゆるゆると綴ります。" />
    <title>yukihrのfjordインターン日記</title>
    
      <link href="/fjord_intern/assets/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css">
    
  </head>
  <body>
    <header>
      <h1 class="brand-name">yukihrのfjordインターン日記<a href="/fjord_intern/">■</a></h1>
      <p class="lead"><a href="//twitter.com/yukihr">yukihr</a>が<a href="//fjord.jp">fjord</a>での<a href="//256interns.com">インターン</a>をゆるーく綴ります。</p>
    </header>

    <hr/>
    
    <div id="main" role="main">
      
<article class="article" itemscope itemtype="http://schema.org/Article">
  
    <header>
      <h1 class="title" itemprop="name">
        リファクタリングについて考えたりとか、rspecの高速化とか
      </h1>
      <div class="meta">
        <time class="date" itemprop="datePublished" content="2013-11-14T13:09:00+09:00" datetime="2013-11-14T13:09:00+09:00" pubdate>
  <span class="year">2013</span>-<span class="month">11</span>-<span class="day">14</span>
</time>
/
        <span>18日目</span>/
        <span>4週目・作業週</span>

        
          <a class="comment" href="#disqus_thread"><span>コメント</span></a>
        
      </div>
    </header>
  

  <div class="body markdown" itemprop="articleBody"><div class="toc"><ul>
<li>
<a href="#toc_0">再度リファクタリング</a>
<ul>
<li>
<a href="#toc_1">方針</a>
</li>
</ul>
</li>
<li>
<a href="#toc_2">Springでrspecの高速化</a>
<ul>
<li>
<a href="#toc_3">参考その１</a>
</li>
<li>
<a href="#toc_4">参考その２</a>
</li>
<li>
<a href="#toc_5">guard、使ったほうががいいですか</a>
</li>
<li>
<a href="#toc_6">Gitのpre-commit-hookでテスト走らせる</a>
</li>
</ul>
</li>
<li>
<a href="#toc_7">Capybaraを使ったテストがOpenSSL::SSL::SSLErrorでコケる</a>
</li>
<li>
<a href="#toc_8">新知識</a>
</li>
</ul>
</div>

<h1 id="toc_0">再度リファクタリング</h1>

<p>ActiveDecoratorで実装してた部分をModelに移す。&lt;- 見た目に関係しないコードはできるだけモデルでやる方針</p>

<h2 id="toc_1">方針</h2>

<ol>
<li>内部でhelperを使ってないコードとそうでないコードをわける</li>
</ol>

<h1 id="toc_2">Springでrspecの高速化</h1>

<p>単体テストを手動で走らせるのに結構時間かかるので。</p>

<p>調べると、springというのが良さそう。</p>

<ul>
<li><a title="jonleighton/spring" href="https://github.com/jonleighton/spring">jonleighton/spring</a></li>
</ul>

<p>個人でつかうため、プロジェクトのGemfileは使わずにやる方法。</p>
<pre class="highlight shell"><span class="gp">$ </span>gem install spring
<span class="gp">$ </span>spring rspec
</pre>
<p>gem バージョンが古いというエラーが出るので、gemのアップデート</p>
<pre class="highlight shell"><span class="gp">$ </span>gem install rubygems-update
<span class="gp">$ </span>update_rubygems
</pre>
<p>次のようにするといいらしい</p>
<pre class="highlight shell"><span class="gp">$ </span>gem pristine --all
</pre>
<blockquote>
<p><code>gem pristine</code>: gemの隠し場所にあるファイルからインストールしたgemを初期状態へ戻す</p>
</blockquote>

<p>from: <a title="Rubyのパッケージマネジメントシステムgem(Rubygems)のコマンド一覧" href="http://blog.layer8.sh/ja/2012/04/16/ruby%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0gemrubygems%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3/">Rubyのパッケージマネジメントシステムgem(Rubygems)のコマンド一覧</a></p>
<pre class="highlight shell"><span class="gp">$ </span>spring rspec hoge_spec.rb
Version: 0.9.2

Usage: spring COMMAND <span class="o">[</span>ARGS]

Commands <span class="k">for </span>spring itself:
....
</pre>
<p>あれ・・・？</p>

<ul>
<li><a title="jonleighton/spring-commands-rspec" href="https://github.com/jonleighton/spring-commands-rspec">jonleighton/spring-commands-rspec</a></li>
</ul>

<p>こういうのがある</p>
<pre class="highlight shell"><span class="gp">$ </span>gem install spring-commands-rspec
</pre>
<p><code>~/.spring.rb</code>に次のように書く</p>
<pre class="highlight ruby"><span class="nb">require</span> <span class="s2">&quot;spring/commands/rspec&quot;</span>
</pre><pre class="highlight shell">spring rspec path/to/hoge_spec.rb
</pre>
<p>成功。結構速くなってハッピー</p>

<h2 id="toc_3">参考その１</h2>

<p>spec_helper等、specファイル中でロードエラーが出る場合。</p>
<pre class="highlight shell"><span class="gp">$ </span>spring rspec path/to/hoge_spec.rb
require<span class="s1">&#39;: cannot load such file -- spec_helper (LoadError)
</span></pre>
<p>こんな時は、プロジェクトルートで一回<code>spring rspec</code>を実行しておく</p>
<pre class="highlight shell"><span class="gp">$ </span>spring stop
<span class="gp">$ </span><span class="nb">cd</span> <span class="nv">$PROJECT_ROOT</span>
<span class="gp">$ </span>spring rspec path/to/hoge_spec.rb
</pre>
<p>これで、プロジェクトルートをカレントディレクトリとしてspringでrailsが読み込まれるので、requireでパスを正しく読み込める。</p>

<h2 id="toc_4">参考その２</h2>

<p>emacsのrspec-modeで、上記のようにしてspringを使うと、自動ではspringがONにならない。
これはtmpにpidファイルが作られないため。
強制的にspringを使うには、次のように設定する。</p>
<pre class="highlight common_lisp"><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;rspec-mode</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">rspec-spring-p</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">and</span> <span class="nv">rspec-use-spring-when-possible</span>
       <span class="p">(</span><span class="nb">stringp</span> <span class="p">(</span><span class="nv">executable-find</span> <span class="s">&quot;spring&quot;</span><span class="p">))))</span>
</pre>
<p>ちなみに、rspec-modeでは<code>C-c , v</code>で開いているファイルに関連するテストだけを走らせる事ができる。</p>

<h2 id="toc_5">guard、使ったほうががいいですか</h2>

<p>guardと組み合わせて使ってる人が多いみたい。guardは以前rails-tutorialやってる時に使ったけど、裏で走り続けるのがCPUの無駄使いにしか思えなくて使わなくなってしまった。guardの結果がエラーでも無視してコーディングすることも多かった。guard使ったほうがいい理由は、書いているコードが意図しない影響をもたらしてしまうことにすぐに気付いて方向修正できることなんだろうけど、commitの前にテストが通るか確認するだけでも十分な気もする。</p>

<h2 id="toc_6">Gitのpre-commit-hookでテスト走らせる</h2>

<p>そんなことを考えていて、Gitのpre-commit-hookでテスト走らせればいいんじゃないかと思いつきました。同じようなことを考えた先達がいたようです。</p>

<ul>
<li><a title="markhazlett/RSpec-Pre-commit-Git-Hook" href="https://github.com/markhazlett/RSpec-Pre-commit-Git-Hook">markhazlett/RSpec-Pre-commit-Git-Hook</a></li>
<li><a title="Matjaz Muhic : git pre-commit hook - commit if all RSpec tests passed" href="https://coderwall.com/p/0uuoaq">Matjaz Muhic : git pre-commit hook - commit if all RSpec tests passed</a></li>
</ul>

<p>コミットにあまりに時間がかかるのは考えものですが、一回やってみてもいいかも。</p>

<h1 id="toc_7">Capybaraを使ったテストがOpenSSL::SSL::SSLErrorでコケる</h1>

<p>omniauthで登録する画面でエラーが出る(OSX 10.9, ruby2.0, rails3.2.12)。</p>

<p><code>save_and_open_page</code>でブラウザ開いてみると、<code>OpenSSL::SSL::SSLError</code>。</p>

<ul>
<li><a title="OpenSSL Errors and Rails – Certificate Verify Failed · RailsApps" href="http://railsapps.github.io/openssl-certificate-verify-failed.html">OpenSSL Errors and Rails – Certificate Verify Failed · RailsApps</a></li>
</ul>

<p>ここの、Errors with Ruby 2.0 &gt; Alternative の手順で解決。SSL証明書が古くなっていたのが原因のよう。</p>

<p>kowabanaのローカル環境作った時からコケてて、そういうものかと放置してたのですが、@komagataさんに聞いたところ普通は全部通るとの事だったので、やっぱりか！、と思って調べてみました。</p>

<h1 id="toc_8">新知識</h1>

<ul>
<li><p><a title="Rubyでクラスメソッドをprivateにする正しい方法 - Hello, world! - s21g" href="http://blog.s21g.com/articles/561">Rubyでクラスメソッドをprivateにする正しい方法 - Hello, world! - s21g</a></p></li>
<li><p><a title="Rubyのアクセス制御について(protectとprivate) - おもしろWEBサービス開発日記" href="http://d.hatena.ne.jp/willnet/20080612/1213286518">Rubyのアクセス制御について(protectとprivate) - おもしろWEBサービス開発日記</a></p></li>
<li><p><a title="Active Record scopes vs class methods | Plataformatec Blog" href="http://blog.plataformatec.com.br/2013/02/active-record-scopes-vs-class-methods/">Active Record scopes vs class methods | Plataformatec Blog</a>
scopeじゃなくてClassMethodではだめなの？という疑問に対して</p></li>
</ul>
</div>

  
    <section>
      <div class="article-tag">
        <h2>タグ</h2>
        <ul class="tags horizontal">
  
    <li><a href="../../../tags/rails.html">rails</a></li>
  
</ul>

      </div>
    </section>
  

  
    <section>
      <h2>コメント</h2>
      <div id="disqus_thread" aria-live="polite">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </section>
  

</article>


    </div>

      <script type="text/javascript">
    var disqus_shortname = 'yukihrfjord';
    
      
      
      var disqus_identifier = 'http://yukihr.github.io/fjord_intern/2013/11/14/refactoring-fast-rspec-with-spring';
      var disqus_url = 'http://yukihr.github.io/fjord_intern/2013/11/14/refactoring-fast-rspec-with-spring.html';
      var disqus_script = 'embed.js';
    
    (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
  </script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1&appId=212934732101925";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  <script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

  </body>
</html>
